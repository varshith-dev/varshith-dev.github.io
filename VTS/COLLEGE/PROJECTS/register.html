<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vividly Events | Register for Event</title>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="register.css">
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <header class="main-header">
        <nav class="navbar">
            <a href="index.html" class="logo">
                <span class="vividly">VIVIDLY</span><span class="events">EVENTS</span>
            </a>
            <ul class="nav-links">
                <li><a href="index.html#about">About</a></li>
                <li><a href="index.html#services">Services</a></li>
                <li><a href="index.html#portfolio">Portfolio</a></li>
                <li><a href="photo.html">Gallery</a></li>
                <li><a href="index.html#clients">Clients</a></li>
                <li><a href="index.html#testimonials">Testimonials</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="register-section">
            <div class="container">
                <h2>Event Registration</h2>
                <p class="section-description">Fill out the form below to register for our upcoming event. All fields are required to secure your spot.</p>

                <div class="registration-form-container">
                    <form class="registration-form" id="registrationForm">
                        <div class="form-group">
                            <label for="full-name">Full Name</label>
                            <input type="text" id="full-name" name="fullName" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="company">Company / Organization</label>
                            <input type="text" id="company" name="company" required>
                        </div>
                        <div class="form-group">
                            <label for="job-title">Job Title</label>
                            <input type="text" id="job-title" name="jobTitle" required>
                        </div>
                        <div class="form-group">
                            <label for="event-select">Select Event</label>
                            <select id="event-select" name="eventSelect" required>
                                <option value="">Select an event...</option>
                                <option value="Annual Tech Summit 2025">Annual Tech Summit 2025</option>
                                <option value="New Product Launch">New Product Launch</option>
                                <option value="Corporate Excellence Awards">Corporate Excellence Awards</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="guests">Number of Guests</label>
                            <input type="number" id="guests" name="guests" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="event-date">Event Date</label>
                            <input type="date" id="event-date" name="eventDate" required>
                        </div>
                        <div class="form-group">
                            <label for="event-time">Event Time</label>
                            <input type="time" id="event-time" name="eventTime" required>
                        </div>
                        <div class="form-group terms">
                            <input type="checkbox" id="terms" name="terms" required>
                            <label for="terms">I agree to the <a href="#">Terms and Conditions</a></label>
                        </div>
                        
                        <div class="submit-button-container">
                            <button type="submit" class="cta-button">Register Now</button>
                        </div>
                    </form>
                    <p class="status-check-link">
                        Already registered? <a href="login.html">Check your status here.</a>
                    </p>
                </div>
            </div>
        </section>

        <!-- Message Box -->
        <div id="status-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <p id="modal-message"></p>
                <p>Please keep this ID to check your application status later.</p>
                <button class="cta-button" onclick="window.location.href='login.html'">Go to Status Check</button>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col footer-branding">
                    <h3 class="footer-logo">VIVIDLYEVENTS</h3>
                    <p>Delivering exceptional events with precision and passion. </p>
                    <p>&copy;  Vividly Events. BUILT BY VARSHITH & TEAM</p>
                </div>
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="index.html#services">Our Services</a></li>
                        <li><a href="index.html#portfolio">Portfolio</a></li>
                        <li><a href="photo.html">Gallery</a></li>
                        <li><a href="#">Register</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Follow Us</h4>
                    <div class="social-links">
                        <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, runTransaction } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCGtRmoR3g0L-PwP3KwIJ7b9l7-dSvXrZk",
            authDomain: "vividy-1fec0.firebaseapp.com",
            projectId: "vividy-1fec0",
            storageBucket: "vividy-1fec0.firebasestorage.app",
            messagingSenderId: "696004886445",
            appId: "1:696004886445:web:5fa6290fe574288d326b24",
            measurementId: "G-S1GJ09L8QV"
        };
        const __app_id = "vividy-1fec0";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Sign in anonymously
        async function authenticate() {
            try {
                // Check if a user is already signed in before signing in anonymously
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Error signing in anonymously:", error);
            }
        }
        authenticate();

        // Modal Elements
        const statusModal = document.getElementById('status-modal');
        const modalMessage = document.getElementById('modal-message');
        const closeButton = document.getElementsByClassName('close-button')[0];
        const statusCheckLink = document.querySelector('.status-check-link a');
        
        closeButton.onclick = function() {
            statusModal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == statusModal) {
                statusModal.style.display = "none";
            }
        }

        // Form Submission
        const registrationForm = document.getElementById('registrationForm');

        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            modalMessage.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Registering...`;
            statusModal.style.display = "block";

            const formData = new FormData(registrationForm);
            const data = {
                fullName: formData.get('fullName'),
                email: formData.get('email'),
                company: formData.get('company'),
                jobTitle: formData.get('jobTitle'),
                eventSelect: formData.get('eventSelect'),
                guests: parseInt(formData.get('guests')),
                eventDate: formData.get('eventDate'),
                eventTime: formData.get('eventTime'),
                status: 'pending',
                registrationDate: new Date().toISOString()
            };

            const userId = auth.currentUser ? auth.currentUser.uid : crypto.randomUUID();
            
            // Generate a unique, formatted Event ID using a transaction for atomicity
            const counterDocRef = doc(db, `/artifacts/${__app_id}/counters/events`);
            let eventId;

            try {
                await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterDocRef);
                    let newNumber;
                    if (!counterDoc.exists()) {
                        newNumber = 1;
                        transaction.set(counterDocRef, { value: newNumber });
                    } else {
                        newNumber = counterDoc.data().value + 1;
                        transaction.update(counterDocRef, { value: newNumber });
                    }
                    eventId = `EVN-${String(newNumber).padStart(5, '0')}`;
                });

                await addDoc(collection(db, `/artifacts/${__app_id}/users/${userId}/events`), {
                    ...data,
                    eventId: eventId,
                    userId: userId
                });
                
                modalMessage.innerHTML = `<i class="fas fa-check-circle"></i> Registration successful! Your Event ID is: <strong>${eventId}</strong>.`;
                registrationForm.reset();
                statusCheckLink.href = `login.html?id=${eventId}`;
            } catch (error) {
                console.error("Transaction or document add failed: ", error);
                modalMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> Registration failed. Please try again.`;
            }
        });
    </script>
</body>
</html>
